# orbital_coverage

This tool delivers insights into the orbital phase coverage of existing NenuFAR/LOFAR observations for a given exoplanet. Additionally, it predicts potential future observation windows, ensuring comprehensive orbital phase coverage.

In detail, the tool performs the following tasks:

1. Identifies existing NenuFAR/LOFAR observations for a specific exoplanet by scanning for relevant data stored on disk.
2. Retrieves the exoplanet's orbital details from the NASA Exoplanet Archive.
3. Computes the orbital phase coverage of existing observations, utilizing their timestamps and the exoplanet's orbital information.
4. Forecasts future observation windows for the exoplanet based on its orbital period and the telescope's location.

Outputs generated by the tool include:

1. **Orbital_Phase_Collected** image: A visual representation displaying the timestamps and orbital phases of current observations.
2. **Phase_Coverage_Hist** image: A histogram depicting the orbital phase coverage of existing observations.
3. **Orbital_Slot_Predict** image: A projection indicating upcoming observation windows and their associated orbital phases.
4. **Summary** text: A text document detailing observation timestamps and orbital phases, encompassing both existing data and predictions.


## Installation
Given that the tool searches for directories housing NenuFAR/LOFAR data, it's recommended to execute the code on one of the Nancep machines, ensuring access to /databf (for NenuFAR data) or /databf2 (for LOFAR data).

Before running the code, ensure you have Python3 installed.

Install the required libraries using pip:

```bash
pip install numpy matplotlib astropy h5py astroquery
```

Then the tool can be installed by simply downloading the repositry.

```bash
git clone https://github.com/zhangxiang-planet/orbital_coverage
```

## Usage

This tool can be used by executing the orbital_coverage_interactive.py script. To view the help message and understand the available arguments, run: 

```bash
./orbital_coverage_interactive.py -h
```

A list of available arguments is given below:

```
usage: orbital_coverage_interactive.py [-h] -t TARGET -f FIELD [-i INSTRUMENT] [-o OBSERVATION] [-b BADDATA]
                                       [-fmin FREQMIN] [-m MODE] [-p PERIOD] [-pe PERIODERR] [-j JD] [-pre PREDICT]
                                       [-e ELEVATION] [-s SUN] [-l] [-a]

For an exoplanet, this code provides the orbital phase coverage of existing NenuFAR/LOFAR observations, while
predicting future observing windows to cover the entire orbital phase.

optional arguments:
  -h, --help            show this help message and exit
  -t TARGET, --target TARGET
                        Target name. Must be the same format as used in the NASA exoplanet archive, with spaces
                        replaced with underscores (e.g. tau_boo_b).
  -f FIELD, --field FIELD
                        Field name. Must be the same one used in NenuFAR observations. For example, if field name is
                        TAU_BOO, the code will look for existing observing data directories named with TAU_BOO,
                        while exclude directories with names containing CALIBRATOR.
  -i INSTRUMENT, --instrument INSTRUMENT
                        Telescope used for observation. Can be LOFAR or NENUFAR. For LOFAR, only BEAMFORM
                        observations for TAU BOO are supported for now. Default NENUFAR.
  -o OBSERVATION, --observation OBSERVATION
                        Type of observations to be found. Can be IMAGING or BEAMFORM. Used to search for existing
                        data in nenufar-nri or nenufar-tf directories. Default BEAMFORM.
  -b BADDATA, --baddata BADDATA
                        Bad data list. If True, observations given in the bad data list will be excluded. Default
                        True.
  -fmin FREQMIN, --freqmin FREQMIN
                        Filter previous observations with minimum observing frequency below XX MHz. Only used in
                        BEAMFORM mode. Default 1000.
  -m MODE, --mode MODE  Code driving mode, can be AUTO or MANUAL. If AUTO, the code grabs orbital parameters from
                        NASA exoplanet archive. If MANUAL, the user needs to input orbital parameters. Default AUTO.
  -p PERIOD, --period PERIOD
                        Period of the exoplanet in days. Only used in manual mode. Default 0.
  -pe PERIODERR, --perioderr PERIODERR
                        Period Error of the exoplanet in days. Only used in manual mode. Default 0.
  -j JD, --jd JD        Time of Conjuction (Transit Midpoint) in JD. Only used in manual mode. Default 0.
  -pre PREDICT, --predict PREDICT
                        Predict length in days. Giving observing window for the target in next XX days. Default 30.
  -e ELEVATION, --elevation ELEVATION
                        Target elevation limit in degrees. Only give observing window with target elevation > XX
                        degress. Default 40.
  -s SUN, --sun SUN     Sun elevation limit in degrees. Only give observing window with Sun elevation < XX degress.
                        Default -18.
  -l, --limit           Orbital coverage limit. If set, only give observing window with oribital phase uncovered by
                        previous observations. Default False.
  -a, --avoid           Avoiding observing windows already booked by others. If set, an observing schedule file is
                        required as input. Default False.
```

## Usage scenarios

### Alice wishes to investigate the exoplanet Kepler-42 c.

Although one could attempt to use the tool just with the exoplanet's name, it's essential to provide at least two input arguments: the target name and the field name.

- **Target Name**: This is the name of the exoplanet in the NASA exoplanet archive format. Replace spaces with underscores for compatibility. For instance, the target name for Kepler-42 c becomes **kepler_42_c**. While we suggest using lowercase, it seems that the NASA exoplanet archive is case-insensitive.

- **Field Name**: For NenuFAR observations, this is the name utilized during scheduling, which typically corresponds to the star's name. For Kepler-42 c, the field name is **KEPLER_42**. This must be in uppercase due to NenuFAR's naming conventions.

Given this, Alice can execute the command:

```bash
./orbital_coverage_interactive.py -t kepler_42_c -f KEPLER_42
```

**NOTE**: Exoplanet systems often have alternate names (e.g., Kepler-42 c is also known as KOI-961 c). We strongly advise users to consult the NenuFAR schedule to ensure they're using the correct field names.

### Brian would like to study the exoplanet ups And b. However, he prefers to use orbital parameters from a specific reference.

Brian could activate the MANUAL mode offered by the tool. The tool operates in two distinct modes:

- **AUTO mode**: Here, the tool automatically queries the NASA exoplanet archive to retrieve the RA/DEC, orbital period and its associated error, and the Time of Conjunction (Transit Midpoint) for a specific exoplanet. Given that NASA sources this data from various references, the tool prioritizes the reference with the smallest error in the orbital period.

- **MANUAL mode**: In this mode, the tool only fetches the RA/DEC from the NASA exoplanet archive, allowing the user to provide the necessary orbital information.

Thus, for Brian to utilize data from the preferred reference, he can input the relevant orbital parameters as follows:

```bash
./orbital_coverage_interactive.py -t ups_and_b -f UPS_AND -m MANUAL -p 4.617033 -pe 0.000023 -j 2450005.368
```

### Carol wishes to schedule imaging observations for the exoplanet HD 189733 b, prioritizing orbital phases not already covered by existing observations.

To identify optimal observation times, Carol aims to capture moments when the exoplanet orbits through phases that haven't been observed. Furthermore, she wants to be considerate and avoid times already reserved by other observers.

Here's how Carol can achieve this:

1. **Obtain the NenuFAR Schedule**: Firstly, Carol needs to download the NenuFAR observing schedule. This can be done through the NenuFAR portal (note: a NenuFAR account is required). Simply navigate and click on **Planning -> Booking -> Current Booking.csv** to download the schedule in a CSV format.

2. **Place the Schedule in the Repository**: After downloading, move the schedule file (e.g., **2023-09-04_booking.csv**) to the main repository directory.

3. **Run the Tool**: Execute the following command to identify available timeslots for the next 30 days, focusing on uncovered orbital phases for HD 189733 b:

```bash
./orbital_coverage_interactive.py -t hd_189733_b -f HD_189733 -o IMAGING -l -a
```

The tool allows for further customization. For instance, Carol can modify the **PREDICT**, **ELEVATION**, and **SUN** arguments to adjust the prediction duration, target elevation, and Sun elevation criteria respectively. By default, the tool suggests observation windows where the target elevation exceeds 40 degrees and the Sun's elevation is below -18 degrees (nighttime). Adjust these as needed to fit specific observational requirements.

### David wants to assess the orbital phase coverage of tau Boo b while excluding certain known bad data and avoiding observations at higher frequency bands. 

**Ignoring Known Bad Data**: David can specify which observations to exclude by creating a text file with the start times of the problematic observations. For instance:

```bash
20190323_013900                                         # Old version of pipeline
20190326_012700                                         # Old version of pipeline
20190328_001800                                         # Old version of pipeline
20190330_011100                                         # Old version of pipeline
```

This exclusion file should be named following the pattern: **FIELDNAME_exclude.dat** (e.g., **TAU_BOO_exclude.dat**). He can place this file either in the repository's directory or in the designated exclusion directory:

```bash
/cep/nenufar/nenufar/pro/exoplanets/exclude-from-analysis/
```

Any observation listed in this file will automatically be disregarded during analysis.

**Frequency Considerations**: For specific frequency requirements, David can leverage the **FREQMIN** argument (currently, only BEAMFORM observations are supported):

```bash
./orbital_coverage_interactive.py -t tau_boo_b -f TAU_BOO -fmin 18
```

With this, the tool will consider only those observations with a minimum frequency below 18 MHz.

### Ethan's Assessment of Tau Boo b's Orbital Phase Coverage Using LOFAR

**NOTE**: The tool's compatibility with LOFAR data is currently limited. As of now, it's optimized specifically for Tau Boo. Before analyzing LOFAR data with this tool, please reach out to the developers for guidance.

To calculate the orbital phase coverage of Tau Boo b using LOFAR observations, Ethan can specify the **INSTRUMENT** argument as "LOFAR":

```bash
./orbital_coverage_interactive.py -t tau_boo_b -f TAU_BOO -i LOFAR
```
